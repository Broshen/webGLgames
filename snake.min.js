function init(){debugMode=window.location.search.indexOf("debug")>-1,debugMode?set_text("FIRST PERSON SNAKE","Controls: Use the mouse to steer. <br>Shift to move up. Space to move down.<br> Hold 1 to draw intersection vectors.<br> Hold 2 to pass through floors. <br>Press 3 to land on floor.<br> Press 4 to delete all drawn vectors."):($(".stats").css("display","none"),set_text("FIRST PERSON SNAKE","Controls: Use the mouse to steer. <br>To enable debug mode, append ?debug to the URL.")),camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e3),camera2=new THREE.PerspectiveCamera(75,1,1,1e3),camera2.layers.enable(1),camera2.position.y=200,camera2.rotation.x=-Math.PI/2,scene=new THREE.Scene,controls=new THREE.PointerLockControls(camera),scene.add(controls.getObject()),pos=controls.getObject().position,pos.y=10;var e=new THREE.Mesh(dot_geometry,dot_material);e.position.y=10,e.layers.set(1),snake.push(e),snake[0].lastPosition=new THREE.Vector3(0,0,0),scene.add(e),dots[0]=new THREE.Mesh(dot_geometry,dot_material),dots[0].position.y=10,dots[0].position.x=Math.random()*floorW-150,dots[0].position.z=Math.random()*floorH-150,scene.add(dots[0]),raycaster=new THREE.Raycaster(pos,controls.getObject().getWorldDirection(),0,len);var t=new THREE.PlaneGeometry(floorW,floorH);t.rotateX(-Math.PI/2);var o=new THREE.MeshBasicMaterial({color:"#000000"});floor=new THREE.Mesh(t,o),floor.position.y=5,scene.add(floor);var n=new THREE.BoxGeometry(315,50,5),r=new THREE.MeshBasicMaterial({color:"#333333"});wall[0]=new THREE.Mesh(n,r),wall[1]=new THREE.Mesh(n,r),wall[2]=new THREE.Mesh(n,r),wall[3]=new THREE.Mesh(n,r),wall[0].position.copy(new THREE.Vector3(0,10,155)),wall[1].position.copy(new THREE.Vector3(0,10,-155)),wall[2].position.copy(new THREE.Vector3(155,10,0)),wall[3].position.copy(new THREE.Vector3(-155,10,0)),wall[2].rotateY(Math.PI/2),wall[3].rotateY(Math.PI/2),scene.add(wall[0]),scene.add(wall[1]),scene.add(wall[2]),scene.add(wall[3]),renderer=new THREE.WebGLRenderer,renderer.setClearColor("#d3d3d3"),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(renderer.domElement),document.addEventListener("keydown",on_key_down,!1),document.addEventListener("keyup",on_key_up,!1),document.addEventListener("click",on_click,!1),document.addEventListener("pointerlockchange",pointerlockchange,!1),document.addEventListener("mozpointerlockchange",pointerlockchange,!1),document.addEventListener("webkitpointerlockchange",pointerlockchange,!1),document.addEventListener("pointerlockerror",pointerlockerror,!1),document.addEventListener("mozpointerlockerror",pointerlockerror,!1),window.addEventListener("resize",onWindowResize,!1)}function animate(){if(animationFrameId=requestAnimationFrame(animate),stats.begin(),stats2.begin(),controls.enabled){if(snake[0].position.copy(pos),snake[0].position.distanceToSquared(snake[0].lastPosition)>=15&&!test_keys("W")){for(var e=snake.length-1;e>=1;e--)snake[e].lastPosition.copy(snake[e].position),snake[e].position.copy(snake[e-1].lastPosition);snake[0].lastPosition.copy(snake[0].position)}controls.worldDir=controls.getObject().getWorldDirection(),controls.worldDir.x=Math.round(controls.worldDir.x),controls.worldDir.z=Math.round(controls.worldDir.z),dotIntersects=[],snakeIntersects=[],time=performance.now(),delta=(time-prevTime)/1e3,velocity.x-=10*velocity.x*delta,velocity.z-=10*velocity.z*delta,velocity.y-=10*velocity.y*delta,draw=test_keys("1")&&debugMode,toggleFloor=test_keys("2")&&debugMode,velocity.z-=accel*delta,test_keys("3")&&debugMode&&(pos.y=10),test_keys("4")&&debugMode&&deleteAllArrows(),test_keys("SHIFT")&&debugMode&&(velocity.y+=accel*delta),test_keys("SPACE")&&debugMode&&(velocity.y-=accel*delta),test_keys("SPACE")&&pos.y<=10&&!toggleFloor&&debugMode&&(velocity.y=0);for(var e=0;e<8;e++)wallIntersects[e]=testRay(controls.rays[e],wall),dotIntersects=dotIntersects.concat(testRay(controls.rays[e],dots)),snakeIntersects=snakeIntersects.concat(testRay(controls.rays[e],snake));(!snakeIntersects.every(function(e){return e.object.name<="snake2"})||pos.x>150||pos.x<-150||pos.z>150||pos.z<-150)&&(document.exitPointerLock(),cancelAnimationFrame(animationFrameId),gameHasEnded=!0,set_text("GAME OVER","You've lost! <br> If you're interested in contributing, visit <a href='https://github.com/Broshen/webGLgames'>https://github.com/Broshen/webGLgames</a> <br> To restart the game, refresh the page.")),controls.getObject().translateZ(velocity.z*delta),controls.getObject().translateY(velocity.y*delta),dotIntersects.length>0&&(dots[0].position.x=299*Math.random()-149.5,dots[0].position.z=299*Math.random()-149.5,addToSnake(snake),accel=snake.length/(snake.length+1)*800),prevTime=time}renderer.setViewport(0,0,window.innerWidth,window.innerHeight),renderer.setScissor(0,0,window.innerWidth,window.innerHeight),renderer.setScissorTest(!0),renderer.render(scene,camera),renderer.setViewport(window.innerWidth-camera2size,window.innerHeight-camera2size,camera2size,camera2size),renderer.setScissor(window.innerWidth-camera2size,window.innerHeight-camera2size,camera2size,camera2size),renderer.setScissorTest(!0),renderer.render(scene,camera2),stats.end(),stats2.end()}THREE.PointerLockControls=function(e){var t=this,o=new THREE.Object3D,n=new THREE.Object3D,r=Math.PI/2;this.rays=[new THREE.Vector3(0,0,1),new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,-1),new THREE.Vector3(-1,0,0),new THREE.Vector3(1,0,1),new THREE.Vector3(1,0,-1),new THREE.Vector3(-1,0,-1),new THREE.Vector3(-1,0,1)],this.prevCoords=this.cell=[0,0],this.enabled=!1,this.worldDir=n.getWorldDirection();var s=function(e){if(t.enabled!==!1){var s=e.movementX||e.mozMovementX||e.webkitMovementX||0,a=e.movementY||e.mozMovementY||e.webkitMovementY||0;n.rotation.y-=.002*s,o.rotation.x-=.002*a,o.rotation.x=Math.max(-r,Math.min(r,o.rotation.x))}};this.getObject=function(){return n},this.getPitchObject=function(){return o},e.rotation.set(0,0,0),o.add(e),n.position.y=10,n.add(o),document.addEventListener("mousemove",s,!1)};var key_map={},camera,camera2,scene,renderer,controls,accel=400,wall=[],dots=[],wallIntersects=[],dotIntersects=[],snakeIntersects=[],arrow=[],len=4,toggleFloor=!1,animationFrameId,draw=!1,debugMode=!1,snake=[],camera2size=150,floor;const floorW=300,floorH=300;var dot_geometry=new THREE.SphereGeometry(5,30,30),dot_material=new THREE.MeshBasicMaterial({color:"#ffffff",side:THREE.DoubleSide}),raycaster,element=document.body,gameHasEnded=!1,map_2d={};map_2d.px=7;var prevTime=performance.now(),time=performance.now(),delta,pos,velocity=new THREE.Vector3,stats=new Stats,stats2=new Stats;stats.showPanel(0),stats2.showPanel(2),document.body.appendChild(stats.domElement),document.body.appendChild(stats2.domElement),$(stats.domElement).addClass("stats"),$(stats2.domElement).addClass("stats"),$(stats2.domElement).css("left",$(stats.domElement).width());var alias={CANCEL:3,HELP:6,BACK_SPACE:8,TAB:9,CLEAR:12,ENTER:13,ENTER_SPECIAL:14,SHIFT:16,CONTROL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,KANA:21,EISU:22,JUNJA:23,FINAL:24,HANJA:25,ESCAPE:27,CONVERT:28,NONCONVERT:29,ACCEPT:30,MODECHANGE:31,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,SELECT:41,PRINT:42,EXECUTE:43,PRINTSCREEN:44,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,COLON:58,SEMICOLON:59,LESS_THAN:60,EQUALS:61,GREATER_THAN:62,QUESTION_MARK:63,AT:64,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,OS_KEY:91,CONTEXT_MENU:93,SLEEP:95,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SEPARATOR:108,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NUM_LOCK:144,SCROLL_LOCK:145,WIN_OEM_FJ_JISHO:146,WIN_OEM_FJ_MASSHOU:147,WIN_OEM_FJ_TOUROKU:148,WIN_OEM_FJ_LOYA:149,WIN_OEM_FJ_ROYA:150,CIRCUMFLEX:160,EXCLAMATION:161,DOUBLE_QUOTE:162,HASH:163,DOLLAR:164,PERCENT:165,AMPERSAND:166,UNDERSCORE:167,OPEN_PAREN:168,CLOSE_PAREN:169,ASTERISK:170,PLUS:171,PIPE:172,HYPHEN_MINUS:173,OPEN_CURLY_BRACKET:174,CLOSE_CURLY_BRACKET:175,TILDE:176,VOLUME_MUTE:181,VOLUME_DOWN:182,VOLUME_UP:183,SEMICOLON:186,EQUALS:187,COMMA:188,MINUS:189,PERIOD:190,SLASH:191,BACK_QUOTE:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,QUOTE:222,META:224,ALTGR:225,WIN_ICO_HELP:227,WIN_ICO_00:228,WIN_ICO_CLEAR:230,WIN_OEM_RESET:233,WIN_OEM_JUMP:234,WIN_OEM_PA1:235,WIN_OEM_PA2:236,WIN_OEM_PA3:237,WIN_OEM_WSCTRL:238,WIN_OEM_CUSEL:239,WIN_OEM_ATTN:240,WIN_OEM_FINISH:241,WIN_OEM_COPY:242,WIN_OEM_AUTO:243,WIN_OEM_ENLW:244,WIN_OEM_BACKTAB:245,ATTN:246,CRSEL:247,EXSEL:248,EREOF:249,PLAY:250,ZOOM:251,PA1:253,WIN_OEM_CLEAR:254},on_key_down=on_key_up=function(e){e=e||event,key_map[e.keyCode]="keydown"==e.type},pointerlockchange=function(){document.pointerLockElement===element||document.mozPointerLockElement===element||document.webkitPointerLockElement===element?(controls.enabled=!0,$(".overlay").hide(),prevTime=performance.now()):(controls.enabled=!1,$(".overlay").show())},pointerlockerror=function(e){alert("pointerlockerror",e)},on_click=function(e){e.target==$(".btn")[0]||e.target==$(".description")[0]||gameHasEnded||(element.requestPointerLock=element.requestPointerLock||element.mozRequestPointerLock||element.webkitRequestPointerLock,element.requestPointerLock())},onWindowResize=function(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)},test_key=function(e){return key_map[e]||key_map[alias[e]]},test_keys=function(){for(var e=arguments,t=0;t<e.length;t++)if(!test_key(e[t]))return!1;return!0},testRay=function(e,t){return raycaster.set(pos,e),draw&&(arrow[2]=new THREE.ArrowHelper(e,pos,len,"#FFF000"),arrow[2].name="ArrowHelper",scene.add(arrow[2])),raycaster.intersectObjects(t)},deleteAllArrows=function(){var e=[];scene.children.map(function(t){"ArrowHelper"==t.name&&e.push(t)}),e.map(function(e){scene.remove(e),delete e}),console.log("geometries="+this.renderer.info.memory.geometries+" programs="+this.renderer.info.memory.programs+" textures="+this.renderer.info.memory.textures)},set_text=function(e,t){$(".title").html(e),$(".description").html(t)},addToSnake=function(e){var t=new THREE.Mesh(dot_geometry,dot_material.clone()),o=e.length-1;t.position.copy(e[o].lastPosition),t.lastPosition=new THREE.Vector3(0,0,0),t.name="snake"+o,e.push(t),scene.add(t)};init(),animate();