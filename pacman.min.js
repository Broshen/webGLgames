function GHOST(e,t,o,s,r){GHOST.count=++GHOST.count||1,THREE.Mesh.call(this,ghost_geometry,ghost_material.clone()),this.color=e,this.material.materials[0].color.setHex(this.color),this.activeColor="#"+("00000"+(0|this.color).toString(16)).substr(-6),this.name=t,this.inactivePos=get_vector_from_map(map.length/2-1.5,map[0].length/2-2+GHOST.count-1,20),this.startPos=new THREE.Vector3(-45,10,-5),this.scatterTimes=[7,7,5,5],this.scatterModeTarget=s,this.chaseTimes=[20,20,20],this.position.copy(this.inactivePos),this.lastCell=get_cell(this.position),this.cell=get_cell(this.position),this.mode="scatter",this.previousMode="scatter",this.modeCounter=0,this.velocity=35,this.direction=2,this.hasLeftHouse=!1,this.hasTurned=!1,this.modeBeginTime=time,this.target=r,this.startDots=o,this.get_new_direction=function(e){return"frightened"==this.mode?e[Math.floor(Math.random()*e.length)]:"scatter"==this.mode?get_shortest_direction_to(this.cell,this.scatterModeTarget,e):"chase"==this.mode?this.get_chase_direction(e):"eaten"==this.mode?get_shortest_direction_to(this.cell,[11,14],e):void console.error("Invalid ghost mode: ",this.mode)},this.get_chase_direction=function(e){throw"THE GET CHASE DIRECTION FUNCTION SHOULD BE OVERWRITTEN FOR EVERY GHOST INSTANCE"},this.set_color=function(e){this.material.materials[0].color.setHex(e),this.activeColor="#"+("00000"+(0|e).toString(16)).substr(-6)},this.rotate_left=function(){this.rotateY(-Math.PI/2),this.direction=(this.direction+1)%4},this.tick=function(e,t){if(e.length<=this.startDots&&!this.hasLeftHouse)return this.hasLeftHouse=!0,this.position.copy(ghosts[0].startPos),void(this.modeBeginTime=time);if(this.hasLeftHouse){if(this.lastCell=this.cell,this.cell=get_cell(this.position),"powerPellet"==e.lastDotEaten&&"frightened"!=this.mode?(this.previousMode=this.mode,this.mode="frightened",this.set_color(3162610),this.scatterModeBeginTime=time,this.velocity=30):"powerPellet"==e.lastDotEaten&&"frightened"==this.mode&&(e.lastDotEaten="nothing"),"scatter"==this.mode&&this.modeCounter<4&&time-this.modeBeginTime>1e3*this.scatterTimes[this.modeCounter]?(this.previousMode=this.mode,this.mode="chase",this.modeBeginTime=time):"chase"==this.mode&&this.modeCounter<3&&time-this.modeBeginTime>1e3*this.chaseTimes[this.modeCounter]?(this.previousMode=this.mode,this.mode="scatter",this.modeBeginTime=time,this.modeCounter++):"frightened"==this.mode?time-this.scatterModeBeginTime>8e3?(this.modeBeginTime=time,this.mode=this.previousMode,this.previousMode="frightened",this.set_color(this.color),this.velocity=35):time-this.scatterModeBeginTime>5e3&&(Math.round((time-this.scatterModeBeginTime)/200)%2==0?this.set_color(3162610):this.set_color(16777215)):"eaten"!=this.mode||11!=this.cell[0]||14!=this.cell[1]&&13!=this.cell[1]||(this.mode=this.previousMode,this.modeBeginTime=time,this.geometry=ghost_geometry,this.set_color(this.color),this.velocity=35),Math.abs(this.cell[2])<.3&&Math.abs(this.cell[3])<.3&&!this.hasTurned){var o,s=get_intersections(this.cell[0],this.cell[1],this.direction);if(o=s.length>1?this.get_new_direction(s):s.length>0?s[0]:this.direction,o!=this.direction)for(this.position.copy(get_vector_from_map(this.cell[0],this.cell[1],10));this.direction!=o;)this.rotate_left();this.hasTurned=!0}this.lastCell[0]==this.cell[0]&&this.lastCell[1]==this.cell[1]||!this.hasTurned||(this.hasTurned=!1),this.translateZ(this.velocity*t),this.position.z<-145&&(this.position.z=130),this.position.z>135&&(this.position.z=-140)}draw_2d(this.cell,this.lastCell,this.activeColor)}}function init(){debugMode=window.location.search.indexOf("debug")>-1,debugMode||$(".stats").css("display","none"),camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e3),scene=new THREE.Scene,set_text("FIRST PERSON PACMAN","Controls: WASD To Move, Mouse to look around"),controls=new THREE.PointerLockControls(camera),scene.add(controls.getObject()),pos=controls.getObject().position,pos.x=75,pos.y=10,pos.z=-5,raycaster=new THREE.Raycaster(pos,controls.getObject().getWorldDirection(),0,len),controls.cell=controls.prevCoords=get_cell(pos),setup_map(),setup_ghosts(),renderer=new THREE.WebGLRenderer,renderer.setClearColor("#000000"),renderer.setPixelRatio(window.devicePixelRatio),renderer.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(renderer.domElement),document.addEventListener("keydown",on_key_down,!1),document.addEventListener("keyup",on_key_up,!1),document.addEventListener("click",on_click,!1),document.addEventListener("pointerlockchange",pointerlockchange,!1),document.addEventListener("mozpointerlockchange",pointerlockchange,!1),document.addEventListener("webkitpointerlockchange",pointerlockchange,!1),document.addEventListener("pointerlockerror",pointerlockerror,!1),document.addEventListener("mozpointerlockerror",pointerlockerror,!1),window.addEventListener("resize",onWindowResize,!1)}function animate(){if(animationFrameId=requestAnimationFrame(animate),stats.begin(),stats2.begin(),controls.enabled){draw_2d(controls.cell,controls.prevCoords,"#FFEE00"),controls.worldDir=controls.getObject().getWorldDirection(),controls.worldDir.x=Math.round(controls.worldDir.x),controls.worldDir.z=Math.round(controls.worldDir.z),dotIntersects=[],ghostIntersects=[],time=performance.now(),delta=(time-prevTime)/1e3,velocity.x-=10*velocity.x*delta,velocity.z-=10*velocity.z*delta,velocity.y-=10*velocity.y*delta,draw=test_keys("1")&&debugMode,toggleFloor=test_keys("2")&&debugMode,test_keys("W")&&(velocity.z-=accel*delta),test_keys("S")&&(velocity.z+=accel*delta),test_keys("A")&&(velocity.x-=accel*delta),test_keys("D")&&(velocity.x+=accel*delta),test_keys("3")&&debugMode&&(pos.y=10),test_keys("SHIFT")&&debugMode&&(velocity.y+=accel*delta),test_keys("SPACE")&&debugMode&&(velocity.y-=accel*delta),test_keys("SPACE")&&pos.y<=10&&!toggleFloor&&debugMode&&(velocity.y=0),vectors=getComponents(velocity);for(var e=0;e<8;e++)wallIntersects[e]=testRay(controls.rays[e],wall),dotIntersects=dotIntersects.concat(testRay(controls.rays[e],dots)),ghostIntersects=ghostIntersects.concat(testRay(controls.rays[e],ghosts));if((0==wallIntersects[1].length&&vectors.x>0||0==wallIntersects[3].length&&vectors.x<0)&&(pos.x+=vectors.x*delta),(0==wallIntersects[0].length&&vectors.z>1||0==wallIntersects[2].length&&vectors.z<-1)&&(pos.z+=vectors.z*delta),pos.z<-145&&(pos.z=130),pos.z>135&&(pos.z=-140),controls.getObject().translateY(velocity.y*delta),controls.prevCoords=controls.cell,controls.cell=get_cell(pos),dotIntersects.length>0){scene.remove(dotIntersects[0].object),dots=dots.filter(function(e){return e!==dotIntersects[0].object}),dots.lastDotEaten=dotIntersects[0].object.dotType;var t=get_cell(dotIntersects[0].object.position);map[t[0]][t[1]]=" ",delete dotIntersects[0].object}if(ghostIntersects.length>0){var o=ghostIntersects[0].object;"frightened"==o.mode?(o.mode="eaten",o.geometry=dead_ghost_geometry,o.activeColor="#d3d3d3",o.velocity=40):"eaten"!=o.mode&&(document.exitPointerLock(),cancelAnimationFrame(animationFrameId),gameHasEnded=!0,set_text("GAME OVER","You've lost! If you're interested in contributing, visit <a>https://github.com/Broshen/webGLgames</a>"))}0==dots.length&&(document.exitPointerLock(),cancelAnimationFrame(animationFrameId),gameHasEnded=!0,set_text("GAME OVER","You've won! If you're interested in contributing, visit <a>https://github.com/Broshen/webGLgames</a>")),ghosts[0].tick(dots,delta),ghosts[1].tick(dots,delta),ghosts[2].tick(dots,delta),ghosts[3].tick(dots,delta),prevTime=time}renderer.render(scene,camera),stats.end(),stats2.end()}THREE.PointerLockControls=function(e){var t=this,o=new THREE.Object3D,s=new THREE.Object3D,r=Math.PI/2;this.rays=[new THREE.Vector3(0,0,1),new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,-1),new THREE.Vector3(-1,0,0),new THREE.Vector3(1,0,1),new THREE.Vector3(1,0,-1),new THREE.Vector3(-1,0,-1),new THREE.Vector3(-1,0,1)],this.prevCoords=this.cell=[0,0],this.enabled=!1,this.worldDir=s.getWorldDirection();var i=function(e){if(t.enabled!==!1){var i=e.movementX||e.mozMovementX||e.webkitMovementX||0,n=e.movementY||e.mozMovementY||e.webkitMovementY||0;s.rotation.y-=.002*i,o.rotation.x-=.002*n,o.rotation.x=Math.max(-r,Math.min(r,o.rotation.x))}};this.getObject=function(){return s},this.getPitchObject=function(){return o},e.rotation.set(0,0,0),o.add(e),s.position.y=10,s.add(o),document.addEventListener("mousemove",i,!1)},GHOST.prototype=Object.create(THREE.Mesh.prototype);var key_map={},camera,scene,renderer,controls,accel=400,wall=[],dots=[],wallIntersects=[],dotIntersects=[],ghostIntersects=[],arrow=[],len=4,toggleFloor=!1,animationFrameId,vectors,draw=!1,debugMode=!1,totalDots,raycaster,element=document.body,gameHasEnded=!1,map_2d={};map_2d.px=7;var prevTime=performance.now(),time=performance.now(),delta,pos,velocity=new THREE.Vector3,stats=new Stats,stats2=new Stats;stats.showPanel(0),stats2.showPanel(2),document.body.appendChild(stats.domElement),document.body.appendChild(stats2.domElement),$(stats.domElement).addClass("stats"),$(stats2.domElement).addClass("stats"),$(stats2.domElement).css("left",$(stats.domElement).width());var ghostbody_material=new THREE.MeshBasicMaterial({color:"#ff0000",side:THREE.DoubleSide}),eyeball_material=new THREE.MeshBasicMaterial({color:"#ffffff",side:THREE.DoubleSide}),eye_material=new THREE.MeshBasicMaterial({color:"#000000",side:THREE.DoubleSide}),ghost_material=new THREE.MultiMaterial([ghostbody_material,eyeball_material,eye_material]),ghostHead_geometry=new THREE.SphereGeometry(3,30,30,0,2*Math.PI,0,Math.PI/2),ghostBody_geometry=new THREE.CylinderGeometry(3,3,3,50),ghostEyeball_geometry=new THREE.SphereGeometry(.5,20,20),ghostEye_geometry=new THREE.SphereGeometry(.2,10,10),ghost_geometry=new THREE.Geometry,dead_ghost_geometry=new THREE.Geometry,ghostHead_mesh=new THREE.Mesh(ghostHead_geometry);ghostHead_mesh.position.y=-.5;var ghostBody_mesh=new THREE.Mesh(ghostBody_geometry);ghostBody_mesh.position.y=-2;var eyeBall_z=2.5,eye_z=2.86,eye_x=1.1,ghostEyeball1_mesh=new THREE.Mesh(ghostEyeball_geometry);ghostEyeball1_mesh.position.x=-1,ghostEyeball1_mesh.position.z=eyeBall_z;var ghostEyeball2_mesh=new THREE.Mesh(ghostEyeball_geometry);ghostEyeball2_mesh.position.x=1,ghostEyeball2_mesh.position.z=eyeBall_z;var ghostEye1_mesh=new THREE.Mesh(ghostEye_geometry);ghostEye1_mesh.position.x=-eye_x,ghostEye1_mesh.position.z=eye_z;var ghostEye2_mesh=new THREE.Mesh(ghostEye_geometry);ghostEye2_mesh.position.x=eye_x,ghostEye2_mesh.position.z=eye_z,ghostHead_mesh.updateMatrix(),ghostBody_mesh.updateMatrix(),ghostEye1_mesh.updateMatrix(),ghostEye2_mesh.updateMatrix(),ghostEyeball1_mesh.updateMatrix(),ghostEyeball2_mesh.updateMatrix(),ghost_geometry.merge(ghostEyeball1_mesh.geometry,ghostEyeball1_mesh.matrix,1),ghost_geometry.merge(ghostEyeball2_mesh.geometry,ghostEyeball2_mesh.matrix,1),ghost_geometry.merge(ghostHead_mesh.geometry,ghostHead_mesh.matrix),ghost_geometry.merge(ghostBody_mesh.geometry,ghostBody_mesh.matrix),ghost_geometry.merge(ghostEye1_mesh.geometry,ghostEye1_mesh.matrix,2),ghost_geometry.merge(ghostEye2_mesh.geometry,ghostEye2_mesh.matrix,2),dead_ghost_geometry.merge(ghostEyeball1_mesh.geometry,ghostEyeball1_mesh.matrix,1),dead_ghost_geometry.merge(ghostEyeball2_mesh.geometry,ghostEyeball2_mesh.matrix,1),dead_ghost_geometry.merge(ghostEye1_mesh.geometry,ghostEye1_mesh.matrix,2),dead_ghost_geometry.merge(ghostEye2_mesh.geometry,ghostEye2_mesh.matrix,2);var ghosts=[],map=[["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"],["0","*","*","*","*","*","*","*","*","*","*","*","*","0","0","*","*","*","*","*","*","*","*","*","*","*","*","0"],["0","*","0","0","0","0","*","0","0","0","0","0","*","0","0","*","0","0","0","0","0","*","0","0","0","0","*","0"],["0","X","0","0","0","0","*","0","0","0","0","0","*","0","0","*","0","0","0","0","0","*","0","0","0","0","X","0"],["0","*","0","0","0","0","*","0","0","0","0","0","*","0","0","*","0","0","0","0","0","*","0","0","0","0","*","0"],["0","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","0"],["0","*","0","0","0","0","*","0","0","*","0","0","0","0","0","0","0","0","*","0","0","*","0","0","0","0","*","0"],["0","*","0","0","0","0","*","0","0","*","0","0","0","0","0","0","0","0","*","0","0","*","0","0","0","0","*","0"],["0","*","*","*","*","*","*","0","0","*","*","*","*","0","0","*","*","*","*","0","0","*","*","*","*","*","*","0"],["0","0","0","0","0","0","*","0","0","0","0","0"," ","0","0"," ","0","0","0","0","0","*","0","0","0","0","0","0"],["0","0","0","0","0","0","*","0","0","0","0","0"," ","0","0"," ","0","0","0","0","0","*","0","0","0","0","0","0"],["0","0","0","0","0","0","*","0","0"," "," "," "," "," "," "," "," "," "," ","0","0","*","0","0","0","0","0","0"],["0","0","0","0","0","0","*","0","0"," ","0","0","0","0","0","0","0","0"," ","0","0","*","0","0","0","0","0","0"],["0","0","0","0","0","0","*","0","0"," ","0","0","0","0","0","0","0","0"," ","0","0","*","0","0","0","0","0","0"],["*","*","*","*","*","*","*"," "," "," ","0","0","0","0","0","0","0","0"," "," "," ","*","*","*","*","*","*","*"],["0","0","0","0","0","0","*","0","0"," ","0","0","0","0","0","0","0","0"," ","0","0","*","0","0","0","0","0","0"],["0","0","0","0","0","0","*","0","0"," ","0","0","0","0","0","0","0","0"," ","0","0","*","0","0","0","0","0","0"],["0","0","0","0","0","0","*","0","0"," "," "," "," "," "," "," "," "," "," ","0","0","*","0","0","0","0","0","0"],["0","0","0","0","0","0","*","0","0"," ","0","0","0","0","0","0","0","0"," ","0","0","*","0","0","0","0","0","0"],["0","0","0","0","0","0","*","0","0"," ","0","0","0","0","0","0","0","0"," ","0","0","*","0","0","0","0","0","0"],["0","*","*","*","*","*","*","*","*","*","*","*","*","0","0","*","*","*","*","*","*","*","*","*","*","*","*","0"],["0","*","0","0","0","0","*","0","0","0","0","0","*","0","0","*","0","0","0","0","0","*","0","0","0","0","*","0"],["0","*","0","0","0","0","*","0","0","0","0","0","*","0","0","*","0","0","0","0","0","*","0","0","0","0","*","0"],["0","X","*","*","0","0","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","0","0","*","*","X","0"],["0","0","0","*","0","0","*","0","0","*","0","0","0","0","0","0","0","0","*","0","0","*","0","0","*","0","0","0"],["0","0","0","*","0","0","*","0","0","*","0","0","0","0","0","0","0","0","*","0","0","*","0","0","*","0","0","0"],["0","*","*","*","*","*","*","0","0","*","*","*","*","0","0","*","*","*","*","0","0","*","*","*","*","*","*","0"],["0","*","0","0","0","0","0","0","0","0","0","0","*","0","0","*","0","0","0","0","0","0","0","0","0","0","*","0"],["0","*","0","0","0","0","0","0","0","0","0","0","*","0","0","*","0","0","0","0","0","0","0","0","0","0","*","0"],["0","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","*","0"],["0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0","0"]],alias={CANCEL:3,HELP:6,BACK_SPACE:8,TAB:9,CLEAR:12,ENTER:13,ENTER_SPECIAL:14,SHIFT:16,CONTROL:17,ALT:18,PAUSE:19,CAPS_LOCK:20,KANA:21,EISU:22,JUNJA:23,FINAL:24,HANJA:25,ESCAPE:27,CONVERT:28,NONCONVERT:29,ACCEPT:30,MODECHANGE:31,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT:37,UP:38,RIGHT:39,DOWN:40,SELECT:41,PRINT:42,EXECUTE:43,PRINTSCREEN:44,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,COLON:58,SEMICOLON:59,LESS_THAN:60,EQUALS:61,GREATER_THAN:62,QUESTION_MARK:63,AT:64,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,OS_KEY:91,CONTEXT_MENU:93,SLEEP:95,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SEPARATOR:108,SUBTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,F13:124,F14:125,F15:126,F16:127,F17:128,F18:129,F19:130,F20:131,F21:132,F22:133,F23:134,F24:135,NUM_LOCK:144,SCROLL_LOCK:145,WIN_OEM_FJ_JISHO:146,WIN_OEM_FJ_MASSHOU:147,WIN_OEM_FJ_TOUROKU:148,WIN_OEM_FJ_LOYA:149,WIN_OEM_FJ_ROYA:150,CIRCUMFLEX:160,EXCLAMATION:161,DOUBLE_QUOTE:162,HASH:163,DOLLAR:164,PERCENT:165,AMPERSAND:166,UNDERSCORE:167,OPEN_PAREN:168,CLOSE_PAREN:169,ASTERISK:170,PLUS:171,PIPE:172,HYPHEN_MINUS:173,OPEN_CURLY_BRACKET:174,CLOSE_CURLY_BRACKET:175,TILDE:176,VOLUME_MUTE:181,VOLUME_DOWN:182,VOLUME_UP:183,SEMICOLON:186,EQUALS:187,COMMA:188,MINUS:189,PERIOD:190,SLASH:191,BACK_QUOTE:192,OPEN_BRACKET:219,BACK_SLASH:220,CLOSE_BRACKET:221,QUOTE:222,META:224,ALTGR:225,WIN_ICO_HELP:227,WIN_ICO_00:228,WIN_ICO_CLEAR:230,WIN_OEM_RESET:233,WIN_OEM_JUMP:234,WIN_OEM_PA1:235,WIN_OEM_PA2:236,WIN_OEM_PA3:237,WIN_OEM_WSCTRL:238,WIN_OEM_CUSEL:239,WIN_OEM_ATTN:240,WIN_OEM_FINISH:241,WIN_OEM_COPY:242,WIN_OEM_AUTO:243,WIN_OEM_ENLW:244,WIN_OEM_BACKTAB:245,ATTN:246,CRSEL:247,EXSEL:248,EREOF:249,PLAY:250,ZOOM:251,PA1:253,WIN_OEM_CLEAR:254},on_key_down=on_key_up=function(e){e=e||event,key_map[e.keyCode]="keydown"==e.type},pointerlockchange=function(e){document.pointerLockElement===element||document.mozPointerLockElement===element||document.webkitPointerLockElement===element?(controls.enabled=!0,$(".overlay").hide(),prevTime=performance.now()):(controls.enabled=!1,$(".overlay").show())},pointerlockerror=function(e){alert("pointerlockerror",e)},on_click=function(e){e.target==$(".btn")[0]||e.target==$(".description")[0]||gameHasEnded||(element.requestPointerLock=element.requestPointerLock||element.mozRequestPointerLock||element.webkitRequestPointerLock,element.requestPointerLock())},onWindowResize=function(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight)},test_key=function(e){return key_map[e]||key_map[alias[e]]},test_keys=function(){for(var e=arguments,t=0;t<e.length;t++)if(!test_key(e[t]))return!1;return!0},testRay=function(e,t){return raycaster.set(pos,e),draw&&(arrow[2]=new THREE.ArrowHelper(e,pos,len,"#FFF000"),arrow[2].name="ArrowHelper",scene.add(arrow[2])),raycaster.intersectObjects(t)},deleteAllArrows=function(){var e=[];scene.children.map(function(t){"ArrowHelper"==t.name&&e.push(t)}),e.map(function(e){scene.remove(e),delete e}),console.log("geometries="+this.renderer.info.memory.geometries+" programs="+this.renderer.info.memory.programs+" textures="+this.renderer.info.memory.textures)},getComponents=function(e){var t=new THREE.Vector3,o=new THREE.Euler(0,0,0,"YXZ");o.set(controls.getPitchObject().rotation.x,controls.getObject().rotation.y,0);var s=t.copy(e).applyEuler(o);s.y=0;var r=new THREE.Vector3(s.x,0,0),i=new THREE.Vector3(0,0,s.z);return draw&&(arrow[0]=new THREE.ArrowHelper(s,pos,len,"#FAC123"),arrow[0].name="ArrowHelper",scene.add(arrow[0]),arrow[1]=new THREE.ArrowHelper(r,pos,Math.max(s.x,3),"#FF0000"),arrow[1].name="ArrowHelper",scene.add(arrow[1]),arrow[2]=new THREE.ArrowHelper(i,pos,Math.max(s.z,3),"#0000FF"),arrow[2].name="ArrowHelper",scene.add(arrow[2])),s},get_vector_from_map=function(e,t,o){var s=10*(e-map.length/2),r=o,i=10*(t-map[0].length/2);return new THREE.Vector3(s,r,i)},get_cell=function(e){var t=Math.round(e.x/10+map.length/2),o=Math.round(e.z/10+map[0].length/2),s=t-e.x/10-map.length/2,r=o-e.z/10-map[0].length/2;return[t,o,s,r]},draw_circle=function(e,t,o,s){map_2d.ctx.fillStyle=s,map_2d.ctx.beginPath(),map_2d.ctx.arc(e,t,o,0,2*Math.PI),map_2d.ctx.fill()},draw_line=function(e,t,o,s,r){map_2d.ctx.strokeStyle=r,map_2d.ctx.beginPath(),map_2d.ctx.lineWidth=5,map_2d.ctx.moveTo(e*map_2d.px,t*map_2d.px),map_2d.ctx.lineTo(o*map_2d.px,s*map_2d.px),map_2d.ctx.stroke()},draw_rect=function(e,t,o){map_2d.ctx.fillStyle=o,map_2d.ctx.fillRect(e*map_2d.px,t*map_2d.px,map_2d.px,map_2d.px)},draw_2d=function(e,t,o){try{map[t[0]][t[1]]&&"0"==map[t[0]][t[1]]?map_2d.ctx.fillStyle="#ffffff":map_2d.ctx.fillStyle="#000000",map_2d.ctx.fillRect(t[0]*map_2d.px,t[1]*map_2d.px,map_2d.px,map_2d.px),"*"==map[t[0]][t[1]]?draw_circle((t[0]+.5)*map_2d.px,(t[1]+.5)*map_2d.px,(map_2d.px-4)/2,"#fff000"):"X"==map[t[0]][t[1]]&&draw_circle((t[0]+.5)*map_2d.px,(t[1]+.5)*map_2d.px,(map_2d.px-2)/2,"#ffa500"),map_2d.ctx.fillStyle=o,map_2d.ctx.fillRect(e[0]*map_2d.px,e[1]*map_2d.px,map_2d.px,map_2d.px)}catch(e){console.error(e)}},get_intersections=function(e,t,o){var s=[];return map[e+1][t]&&"0"!=map[e+1][t]&&(o+2)%4!=1?s.push(1):s,map[e-1][t]&&"0"!=map[e-1][t]&&(o+2)%4!=3?s.push(3):s,map[e][t+1]&&"0"!=map[e][t+1]&&(o+2)%4!=2?s.push(2):s,map[e][t-1]&&"0"!=map[e][t-1]&&(o+2)%4!=0?s.push(0):s,s},get_cell_from_direction=function(e,t,o){return 0==o?[e,t-1]:1==o?[e+1,t]:2==o?[e,t+1]:3==o?[e-1,t]:void console.error("Invalid Direction")},get_shortest_direction_to=function(e,t,o){for(var s,r,i=1/0,n=0;n<o.length;n++){var a=get_cell_from_direction(e[0],e[1],o[n]),l=Math.sqrt(Math.pow(a[0]-t[0],2)+Math.pow(a[1]-t[1],2));l<i&&(i=l,s=o[n],r=a)}return s},set_text=function(e,t){$(".title").html(e),$(".description").html(t)},setup_map=function(){var e=document.getElementById("map-2d"),t=e.getContext("2d");map_2d.canvas=e,map_2d.ctx=t,e.height=map_2d.px*map[0].length,e.width=map_2d.px*map.length;var o=new THREE.PlaneGeometry(10*map.length,10*map[0].length);o.rotateX(-Math.PI/2);var s=new THREE.MeshBasicMaterial({color:"#ffffff"}),r=new THREE.Mesh(o,s);r.position.y=5,r.position.z=-5,r.position.x=-5,scene.add(r);for(var i=new THREE.BoxGeometry(10,10,10),n=new THREE.MeshBasicMaterial({color:"#1a237e",side:THREE.DoubleSide}),a=new THREE.SphereGeometry(1,10,10),l=new THREE.MeshBasicMaterial({color:"#fff000",side:THREE.DoubleSide}),c=new THREE.SphereGeometry(3,10,10),h=new THREE.MeshBasicMaterial({color:"#ffa500",side:THREE.DoubleSide}),d=0;d<map.length;d++)for(var m=0;m<map[d].length;m++){var _=map[d][m],p=10*(d-map.length/2),E=10,g=10*(m-map[d].length/2);if("0"==_){var y=new THREE.Mesh(i,n);wall.push(y),scene.add(y),y.position.x=p,y.position.y=E,y.position.z=g,t.fillStyle="#FFFFFF",t.fillRect(d*map_2d.px,m*map_2d.px,map_2d.px,map_2d.px)}else if("*"==_){var w=new THREE.Mesh(a,l);w.dotType="normal",dots.push(w),scene.add(w),w.position.x=p,w.position.y=E,w.position.z=g,t.fillStyle="#000000",t.fillRect(d*map_2d.px,m*map_2d.px,map_2d.px,map_2d.px),draw_circle((d+.5)*map_2d.px,(m+.5)*map_2d.px,(map_2d.px-4)/2,"#fff000")}else if("X"==_){var w=new THREE.Mesh(c,h);w.dotType="powerPellet",dots.push(w),scene.add(w),w.position.x=p,w.position.y=E,w.position.z=g,t.fillStyle="#000000",t.fillRect(d*map_2d.px,m*map_2d.px,map_2d.px,map_2d.px),draw_circle((d+.5)*map_2d.px,(m+.5)*map_2d.px,(map_2d.px-2)/2,"#ffa500")}else t.fillStyle="#000000",t.fillRect(d*map_2d.px,m*map_2d.px,map_2d.px,map_2d.px)}totalDots=dots.length},setup_ghosts=function(){ghosts[0]=new GHOST(16736095,"Blinky",totalDots,[-1,-1],controls),ghosts[1]=new GHOST(16759039,"Pinky",totalDots,[-1,map[0].length+1],controls),ghosts[2]=new GHOST(131071,"Inky",totalDots-30,[map.length+1,-1],controls),ghosts[3]=new GHOST(16758865,"Clyde",totalDots-60,[map.length+1,map[0].length+1],controls),ghosts[0].get_chase_direction=function(e){return get_shortest_direction_to(this.cell,this.target.cell,e)},ghosts[1].get_chase_direction=function(e){var t=[this.target.cell[0]-4*this.target.worldDir.x,this.target.cell[1]-4*this.target.worldDir.z];return get_shortest_direction_to(this.cell,t,e)},ghosts[2].get_chase_direction=function(e){var t=[this.target.cell[0]-2*this.target.worldDir.x,this.target.cell[1]-2*this.target.worldDir.z],o=[2*t[0]-ghosts[0].cell[0],2*t[1]-ghosts[0].cell[1]];return get_shortest_direction_to(this.cell,o,e)},ghosts[3].get_chase_direction=function(e){var t=Math.sqrt(Math.pow(this.cell[0]-this.target.cell[0]),2)+Math.pow(this.cell[1]-this.target.cell[1],2);return t<8?get_shortest_direction_to(this.cell,this.scatterModeTarget,e):get_shortest_direction_to(this.cell,this.target.cell,e)};for(var e=0;e<ghosts.length;e++)scene.add(ghosts[e]);ghosts[0].position.copy(ghosts[0].startPos),ghosts[0].hasLeftHouse=!0,ghosts[0].modeBeginTime=time};init(),animate();var test_scatter_mode_corners=function(){for(var e=0;e<4;e++)console.log(ghosts[e].scatterModeTarget),draw_circle((ghosts[e].scatterModeTarget[0]+.5)*map_2d.px,(ghosts[e].scatterModeTarget[1]+.5)*map_2d.px,(10*map_2d.px-2)/2,ghosts[e].colorStr)},test_direction=function(e,t){switch(t){case 0:draw_rect(e[0],e[1]-1,"#fff000");break;case 1:draw_rect(e[0]+1,e[1],"#fff000");break;case 2:draw_rect(e[0],e[1]+1,"#fff000");break;case 3:draw_rect(e[0]-1,e[1],"#fff000")}};